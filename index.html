<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Projetos (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f3f4f6; }
        /* Classes de Status e Estilos */
        .status-select { padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-weight: 500; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-position: right 8px center; background-repeat: no-repeat; background-size: 14px; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M6 9l4 4 4-4'/%3e%3c/svg%3e"); }
        .status-default { background-color: #f3f4f6; color: #4b5563; }
        .status-pendente { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .status-andamento { background-color: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .status-pendente-associa { background-color: #fef9c3; color: #a16207; border-color: #fde047; }
        .status-finalizado { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .indicator-input-table { width: 70px; padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; background-color: #f9fafb; transition: all 0.2s; }
        .indicator-input-table:focus { outline: none; border-color: #FF5510; background-color: #fff; box-shadow: 0 0 0 2px rgba(255, 85, 16, 0.2); }
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        #toast { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .obs-filled { color: #3b82f6; } .obs-filled:hover { color: #1d4ed8; }
        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #FF5510; }
        .hidden-overlay { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay">Conectando ao banco de dados...</div>

    <aside id="filter-sidebar" class="fixed top-0 left-0 z-30 w-72 h-screen bg-white shadow-lg p-6 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <h3 class="text-xl font-extrabold text-gray-800 mb-6">Filtros</h3>
        <div class="space-y-4 overflow-y-auto h-[calc(100vh-160px)] pr-2">
            <div><label class="block text-sm font-medium text-gray-700">Analista</label><select id="filter-analista" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">GE</label><select id="filter-ge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Associado</label><select id="filter-associado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">UF</label><select id="filter-uf" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Anjo</label><select id="filter-anjo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Bandeira</label><select id="filter-bandeira" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Projeto</label><select id="filter-projeto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">CNPJ</label><input type="text" id="filter-cnpj" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="CNPJ"></div>
            <div><label class="block text-sm font-medium text-gray-700">Loja</label><input type="text" id="filter-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Loja"></div>
        </div>
        <div class="absolute bottom-6 left-6 right-6 space-y-3">
            <button id="apply-filters-btn" class="w-full bg-[#FF5510] text-white py-2 px-4 rounded-lg font-semibold hover:bg-[#E04A0E] shadow">Aplicar</button>
            <button id="clear-filters-btn" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300">Limpar</button>
        </div>
    </aside>

    <main id="main-content" class="md:ml-72 transition-all duration-300 ease-in-out p-6">
        <header class="mb-6">
            <nav class="bg-white rounded-lg shadow-sm p-4 flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <button id="toggle-filter-btn" class="text-gray-600 md:hidden mr-4 p-2 rounded-md hover:bg-gray-100"><i class="fa-solid fa-bars fa-lg"></i></button>
                    <h1 class="text-3xl font-extrabold text-[#FF5510]">Dashboard (Online)</h1>
                </div>
                <button id="open-modal-btn" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg font-semibold hover:bg-[#E04A0E] shadow flex items-center space-x-2"><i class="fa-solid fa-plus"></i><span>Inserir Loja</span></button>
            </nav>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-black"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Total Lojas</h4><p id="kpi-total-lojas" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-500"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Pendentes</h4><p id="kpi-projetos-pendentes" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-yellow-400"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Pendente Assoc.</h4><p id="kpi-projetos-pendentes-associa" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Em Andamento</h4><p id="kpi-em-andamento" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Finalizados</h4><p id="kpi-projetos-finalizados" class="text-3xl font-extrabold text-gray-900">0</p></div>
            </div>
        </header>

        <section class="mb-6 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Gráfico Consolidado</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                <div><label class="block text-sm font-medium text-gray-700">Projeto</label><select id="chart-filter-project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">GE</label><select id="chart-filter-ge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">Todos</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700">CNPJ ou Loja</label><input type="text" id="chart-filter-cnpj-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Filtrar..."></div>
                <button id="generate-chart-btn" class="w-full md:w-auto bg-[#FF5510] text-white py-2 px-5 rounded-lg font-semibold hover:bg-[#E04A0E] shadow h-10">Gerar Gráfico</button>
            </div>
            <div class="relative h-96"><canvas id="consolidated-chart"></canvas></div>
        </section>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="p-4 border-b"><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fa-solid fa-search"></i></span><input type="text" id="search-input" placeholder="Pesquisar..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300"></div></div>
            <div class="overflow-x-auto max-h-[calc(100vh-320px)]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Loja</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">CNPJ</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Analista</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">GE</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Associado</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Bandeira</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Projeto</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Status</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Meta</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ago/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Set/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Out/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nov/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Dez/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jan/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Fev/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Mar/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Abr/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Mai/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jun/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jul/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ago/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Set/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Out/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nov/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Dez/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Obs</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="project-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 z-50">Mensagem</div>

    <div id="store-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <header class="flex justify-between items-center p-5 border-b"><h2 id="store-modal-title" class="text-xl font-extrabold text-gray-800">Nova Loja</h2><button id="close-modal-btn" class="text-gray-500"><i class="fa-solid fa-times"></i></button></header>
            <form id="store-form" class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium">Nome da Loja</label><input type="text" id="nome-loja" name="nome-loja" required class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">CNPJ (ID)</label><input type="text" id="cnpj" name="cnpj" required class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">Analista</label><input type="text" id="analista" name="analista" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">GE</label><input type="text" id="ge" name="ge" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">Associado</label><input type="text" id="associado" name="associado" class="w-full rounded-md border-gray-300"></div>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium">Bandeira</label><input type="text" id="bandeira" name="bandeira" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">UF</label><input type="text" id="uf" name="uf" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">Anjo</label><input type="text" id="anjo" name="anjo" class="w-full rounded-md border-gray-300"></div>
                        <div id="form-project-group">
                            <label class="block text-sm font-medium">Projeto</label>
                            <select id="nome-projeto" name="nome-projeto" required class="w-full rounded-md border-gray-300"></select>
                        </div>
                        <div id="form-meta-group"><label class="block text-sm font-medium">Meta</label><input type="number" id="meta" name="meta" class="w-full rounded-md border-gray-300"></div>
                        <div id="form-observation-group"><label class="block text-sm font-medium">Obs</label><textarea id="observation" name="observation" rows="3" class="w-full rounded-md border-gray-300"></textarea></div>
                    </div>
                </div>
            </form>
            <footer class="flex justify-end items-center p-5 border-t bg-gray-50">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg mr-3">Cancelar</button>
                <button id="save-store-btn" type="submit" form="store-form" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg">Salvar</button>
            </footer>
        </div>
    </div>

    <div id="obs-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg"><header class="flex justify-between p-5 border-b"><h2 id="obs-modal-title" class="font-bold">Observações</h2><button id="close-obs-modal-btn"><i class="fa-solid fa-times"></i></button></header><div class="p-6"><textarea id="obs-modal-textarea" rows="8" class="w-full rounded-md border-gray-300"></textarea></div><footer class="flex justify-end p-5 border-t"><button id="cancel-obs-btn" class="bg-gray-200 py-2 px-5 rounded-lg mr-3">Cancelar</button><button id="save-obs-btn" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg">Salvar</button></footer></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-md"><div class="p-6"><p id="delete-modal-text">Confirmar exclusão?</p></div><footer class="flex justify-end p-5 border-t"><button id="cancel-delete-btn" class="bg-gray-200 py-2 px-5 rounded-lg mr-3">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-5 rounded-lg">Excluir</button></footer></div></div>
    <div id="chart-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-4xl"><header class="flex justify-between p-5 border-b"><h2 id="chart-modal-title" class="font-bold">Gráfico</h2><button id="close-chart-modal-btn"><i class="fa-solid fa-times"></i></button></header><div class="p-6"><div class="mb-4 flex justify-center space-x-4"><label><input type="radio" name="chart-format" value="number" checked> Num</label><label><input type="radio" name="chart-format" value="currency"> R$</label><label><input type="radio" name="chart-format" value="percent"> %</label></div><canvas id="indicator-chart"></canvas></div></div></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // --- SUAS CHAVES DO FIREBASE JÁ INTEGRADAS ABAIXO ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuQpx3JvBZ1aoF7eDueGQ9DQZCWfmsrjc",
            authDomain: "dashboard-projetos-ddafa.firebaseapp.com",
            projectId: "dashboard-projetos-ddafa",
            storageBucket: "dashboard-projetos-ddafa.firebasestorage.app",
            messagingSenderId: "179968218754",
            appId: "1:179968218754:web:ab862528bf152d29f7869b"
        };
        // ----------------------------------------------------

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase conectado com sucesso!");
        } catch (error) {
            console.error("Erro ao conectar Firebase:", error);
            alert("Erro na conexão do Firebase. Verifique o console.");
        }

        const projectList = ["MIX DE PRODUTOS", "PRECIFICAÇÃO", "PBM", "PEC", "SETORIZAÇÃO (ESTACIONAMENTO)", "MARCAS PROPRIAS", "GC (FARMACINHA)", "DELIVERY (E-DELIVERY)", "INSPIRE +", "DERMACLUB", "SERVIÇOS FARMACEUTICOS", "CAMPANHA IDOSO", "MEDICAMENTOS ESPECIAIS", "FIDELIZA MAIS"];
        const statusList = [
            { value: 'pendente', text: 'Pendente', class: 'status-pendente' },
            { value: 'andamento', text: 'Em Andamento', class: 'status-andamento' },
            { value: 'pendente-associa', text: 'Pendente Associado', class: 'status-pendente-associa' },
            { value: 'finalizado', text: 'Finalizado', class: 'status-finalizado' }
        ];
        const indicatorMonths = [
            { id: 'aug2025', label: 'Ago/2025' }, { id: 'sep2025', label: 'Set/2025' }, { id: 'oct2025', label: 'Out/2025' }, { id: 'nov2025', label: 'Nov/2025' }, { id: 'dec2025', label: 'Dez/2025' },
            { id: 'jan2026', label: 'Jan/2026' }, { id: 'feb2026', label: 'Fev/2026' }, { id: 'mar2026', label: 'Mar/2026' }, { id: 'apr2026', label: 'Abr/2026' }, { id: 'may2026', label: 'Mai/2026' },
            { id: 'jun2026', label: 'Jun/2026' }, { id: 'jul2026', label: 'Jul/2026' }, { id: 'aug2026', label: 'Ago/2026' }, { id: 'sep2026', label: 'Set/2026' }, { id: 'oct2026', label: 'Out/2026' },
            { id: 'nov2026', label: 'Nov/2026' }, { id: 'dec2026', label: 'Dez/2026' }
        ];
        const chartLabels = indicatorMonths.map(m => m.label);

        let allFlattenedData = [];
        let currentChartInstance = null;
        let consolidatedChartInstance = null;
        let currentChartRowData = null;

        const loadingOverlay = document.getElementById('loading-overlay');
        const projectTableBody = document.getElementById('project-table-body');
        const storeModal = document.getElementById('store-modal');
        const storeForm = document.getElementById('store-form');
        const toast = document.getElementById('toast');

        function iniciarOuvinteFirebase() {
            if (!db) return;
            const q = collection(db, "lojas");
            onSnapshot(q, (querySnapshot) => {
                const stores = [];
                querySnapshot.forEach((doc) => {
                    stores.push({ id: doc.id, ...doc.data() });
                });
                processarDados(stores);
                loadingOverlay.classList.add('hidden-overlay');
            }, (error) => {
                console.error("Erro ao ler dados:", error);
                showToast("Erro: " + error.message, true);
                loadingOverlay.innerHTML = "<div>Erro de conexão. Verifique o console.</div>";
            });
        }

        function processarDados(stores) {
            allFlattenedData = [];
            const filterOptions = { analistas: new Set(), ges: new Set(), associados: new Set(), anjos: new Set(), ufs: new Set(), bandeiras: new Set() };
            stores.forEach((store) => {
                if (store.analista) filterOptions.analistas.add(store.analista);
                if (store.ge) filterOptions.ges.add(store.ge);
                if (store.associado) filterOptions.associados.add(store.associado);
                if (store.anjo) filterOptions.anjos.add(store.anjo);
                if (store.uf) filterOptions.ufs.add(store.uf);
                if (store.bandeira) filterOptions.bandeiras.add(store.bandeira);
                if (store.projects) {
                    Object.keys(store.projects).forEach(projectName => {
                        const project = store.projects[projectName];
                        const row = {
                            ...store,
                            projectName: projectName,
                            status: project.status,
                            goal: project.goal || '',
                            observation: project.observation || '',
                            ...project.indicators
                        };
                        delete row.projects;
                        allFlattenedData.push(row);
                    });
                }
            });
            allFlattenedData.sort((a, b) => a.nomeLoja.localeCompare(b.nomeLoja));
            recalculateKPIs();
            populateFilterSelects(filterOptions);
            applyAllFilters();
        }

        async function salvarLojaFirebase(storeId, data) {
            try { await setDoc(doc(db, "lojas", storeId), data, { merge: true }); showToast("Dados salvos!"); }
            catch (error) { console.error(error); showToast("Erro ao salvar", true); }
        }

        async function atualizarProjetoFirebase(storeId, projectName, fieldPath, value) {
            try {
                const docRef = doc(db, "lojas", storeId);
                const updateKey = `projects.${projectName}.${fieldPath}`;
                await updateDoc(docRef, { [updateKey]: value });
            } catch (error) { console.error(error); showToast("Erro ao atualizar", true); }
        }
        
        async function deletarProjetoFirebase(storeId, projectName) {
            try {
                const docRef = doc(db, "lojas", storeId);
                const { deleteField } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                await updateDoc(docRef, { [`projects.${projectName}`]: deleteField() });
                showToast("Projeto excluído!");
            } catch (error) { console.error(error); showToast("Erro ao excluir", true); }
        }

        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-store-btn');
            btn.textContent = 'Salvando...'; btn.disabled = true;
            const formData = new FormData(storeForm);
            const storeId = formData.get('cnpj');
            const isEditMode = document.getElementById('cnpj').readOnly;
            const storeData = {
                analista: formData.get('analista'), anjo: formData.get('anjo'), uf: formData.get('uf'),
                bandeira: formData.get('bandeira'), ge: formData.get('ge'), associado: formData.get('associado'),
                nomeLoja: formData.get('nome-loja'),
            };

            if (isEditMode) {
                await salvarLojaFirebase(storeId, storeData);
            } else {
                const projectName = formData.get('nome-projeto');
                if (!storeId || !projectName) { showToast("CNPJ e Projeto obrigatórios", true); btn.disabled=false; return; }
                const indicators = {}; indicatorMonths.forEach(m => indicators[m.id] = '');
                const newProject = { status: 'pendente', goal: formData.get('meta')||'', observation: formData.get('observation')||'', indicators: indicators };
                await setDoc(doc(db, "lojas", storeId), storeData, { merge: true });
                await updateDoc(doc(db, "lojas", storeId), { [`projects.${projectName}`]: newProject });
            }
            document.getElementById('store-modal').classList.add('hidden');
            storeForm.reset();
            btn.textContent = 'Salvar'; btn.disabled = false;
        };
        
        window.handleStatusChange = (e) => { const { storeId, projectName } = e.target.dataset; atualizarProjetoFirebase(storeId, projectName, "status", e.target.value); updateStatusColor(e.target); };
        window.handleIndicatorChange = (e) => { const { storeId, projectName, month } = e.target.dataset; atualizarProjetoFirebase(storeId, projectName, `indicators.${month}`, e.target.value); };
        window.handleMetaChange = (e) => { const { storeId, projectName } = e.target.dataset; atualizarProjetoFirebase(storeId, projectName, "goal", e.target.value); };
        window.handleSaveObservation = () => { const btn = document.getElementById('save-obs-btn'); const { storeId, projectName } = btn.dataset; atualizarProjetoFirebase(storeId, projectName, "observation", document.getElementById('obs-modal-textarea').value); document.getElementById('obs-modal').classList.add('hidden'); showToast("Obs salva!"); };
        window.confirmProjectDelete = () => { const btn = document.getElementById('confirm-delete-btn'); deletarProjetoFirebase(btn.dataset.storeId, btn.dataset.projectName); document.getElementById('delete-confirm-modal').classList.add('hidden'); };

        function showToast(msg, err=false) { toast.textContent=msg; toast.className = `fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg transform transition-all duration-300 z-50 ${err?'bg-red-600':'bg-green-600'} translate-x-0 opacity-100`; setTimeout(()=>toast.classList.add('translate-x-full', 'opacity-0'), 3000); }
        function updateStatusColor(el) { statusList.forEach(s=>el.classList.remove(s.class)); const st = statusList.find(s=>s.value===el.value); if(st)