<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Projetos (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f3f4f6; }
        /* Classes de Status e Estilos (Mantidos iguais) */
        .status-select { padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-weight: 500; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-position: right 8px center; background-repeat: no-repeat; background-size: 14px; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M6 9l4 4 4-4'/%3e%3c/svg%3e"); }
        .status-default { background-color: #f3f4f6; color: #4b5563; }
        .status-pendente { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .status-andamento { background-color: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .status-pendente-associa { background-color: #fef9c3; color: #a16207; border-color: #fde047; }
        .status-finalizado { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .indicator-input-table { width: 70px; padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; background-color: #f9fafb; transition: all 0.2s; }
        .indicator-input-table:focus { outline: none; border-color: #FF5510; background-color: #fff; box-shadow: 0 0 0 2px rgba(255, 85, 16, 0.2); }
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        #toast { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .obs-filled { color: #3b82f6; } .obs-filled:hover { color: #1d4ed8; }
        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #FF5510; }
        .hidden-overlay { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay">Carregando dados do Firebase...</div>

    <aside id="filter-sidebar" class="fixed top-0 left-0 z-30 w-72 h-screen bg-white shadow-lg p-6 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <h3 class="text-xl font-extrabold text-gray-800 mb-6">Filtros</h3>
        <div class="space-y-4 overflow-y-auto h-[calc(100vh-160px)] pr-2">
            <div><label class="block text-sm font-medium text-gray-700">Analista</label><select id="filter-analista" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">GE</label><select id="filter-ge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Associado</label><select id="filter-associado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">UF</label><select id="filter-uf" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Anjo</label><select id="filter-anjo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Bandeira</label><select id="filter-bandeira" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Projeto</label><select id="filter-projeto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
            <div><label class="block text-sm font-medium text-gray-700">CNPJ</label><input type="text" id="filter-cnpj" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="CNPJ"></div>
            <div><label class="block text-sm font-medium text-gray-700">Loja</label><input type="text" id="filter-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Loja"></div>
        </div>
        <div class="absolute bottom-6 left-6 right-6 space-y-3">
            <button id="apply-filters-btn" class="w-full bg-[#FF5510] text-white py-2 px-4 rounded-lg font-semibold hover:bg-[#E04A0E] shadow">Aplicar</button>
            <button id="clear-filters-btn" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300">Limpar</button>
        </div>
    </aside>

    <main id="main-content" class="md:ml-72 transition-all duration-300 ease-in-out p-6">
        <header class="mb-6">
            <nav class="bg-white rounded-lg shadow-sm p-4 flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <button id="toggle-filter-btn" class="text-gray-600 md:hidden mr-4 p-2 rounded-md hover:bg-gray-100"><i class="fa-solid fa-bars fa-lg"></i></button>
                    <h1 class="text-3xl font-extrabold text-[#FF5510]">Dashboard (Online)</h1>
                </div>
                <button id="open-modal-btn" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg font-semibold hover:bg-[#E04A0E] shadow flex items-center space-x-2"><i class="fa-solid fa-plus"></i><span>Inserir Loja</span></button>
            </nav>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-black"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Total Lojas</h4><p id="kpi-total-lojas" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-500"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Pendentes</h4><p id="kpi-projetos-pendentes" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-yellow-400"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Pendente Assoc.</h4><p id="kpi-projetos-pendentes-associa" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Em Andamento</h4><p id="kpi-em-andamento" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500"><h4 class="text-sm font-medium text-gray-500 mb-1 uppercase">Finalizados</h4><p id="kpi-projetos-finalizados" class="text-3xl font-extrabold text-gray-900">0</p></div>
            </div>
        </header>

        <section class="mb-6 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Gráfico Consolidado</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                <div><label class="block text-sm font-medium text-gray-700">Projeto</label><select id="chart-filter-project" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">GE</label><select id="chart-filter-ge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">Todos</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700">CNPJ ou Loja</label><input type="text" id="chart-filter-cnpj-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Filtrar..."></div>
                <button id="generate-chart-btn" class="w-full md:w-auto bg-[#FF5510] text-white py-2 px-5 rounded-lg font-semibold hover:bg-[#E04A0E] shadow h-10">Gerar Gráfico</button>
            </div>
            <div class="relative h-96"><canvas id="consolidated-chart"></canvas></div>
        </section>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="p-4 border-b"><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fa-solid fa-search"></i></span><input type="text" id="search-input" placeholder="Pesquisar..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300"></div></div>
            <div class="overflow-x-auto max-h-[calc(100vh-320px)]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Loja</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">CNPJ</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Analista</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">GE</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Associado</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Bandeira</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Projeto</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Status</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Meta</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ago/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Set/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Out/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nov/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Dez/25</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jan/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Fev/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Mar/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Abr/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Mai/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jun/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jul/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ago/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Set/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Out/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nov/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Dez/26</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Obs</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="project-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 z-50">Mensagem</div>

    <div id="store-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <header class="flex justify-between items-center p-5 border-b"><h2 id="store-modal-title" class="text-xl font-extrabold text-gray-800">Nova Loja</h2><button id="close-modal-btn" class="text-gray-500"><i class="fa-solid fa-times"></i></button></header>
            <form id="store-form" class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium">Nome da Loja</label><input type="text" id="nome-loja" name="nome-loja" required class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">CNPJ (ID)</label><input type="text" id="cnpj" name="cnpj" required class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">Analista</label><input type="text" id="analista" name="analista" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">GE</label><input type="text" id="ge" name="ge" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">Associado</label><input type="text" id="associado" name="associado" class="w-full rounded-md border-gray-300"></div>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium">Bandeira</label><input type="text" id="bandeira" name="bandeira" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">UF</label><input type="text" id="uf" name="uf" class="w-full rounded-md border-gray-300"></div>
                        <div><label class="block text-sm font-medium">Anjo</label><input type="text" id="anjo" name="anjo" class="w-full rounded-md border-gray-300"></div>
                        <div id="form-project-group">
                            <label class="block text-sm font-medium">Projeto</label>
                            <select id="nome-projeto" name="nome-projeto" required class="w-full rounded-md border-gray-300"></select>
                        </div>
                        <div id="form-meta-group"><label class="block text-sm font-medium">Meta</label><input type="number" id="meta" name="meta" class="w-full rounded-md border-gray-300"></div>
                        <div id="form-observation-group"><label class="block text-sm font-medium">Obs</label><textarea id="observation" name="observation" rows="3" class="w-full rounded-md border-gray-300"></textarea></div>
                    </div>
                </div>
            </form>
            <footer class="flex justify-end items-center p-5 border-t bg-gray-50">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg mr-3">Cancelar</button>
                <button id="save-store-btn" type="submit" form="store-form" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg">Salvar</button>
            </footer>
        </div>
    </div>

    <div id="obs-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg"><header class="flex justify-between p-5 border-b"><h2 id="obs-modal-title" class="font-bold">Observações</h2><button id="close-obs-modal-btn"><i class="fa-solid fa-times"></i></button></header><div class="p-6"><textarea id="obs-modal-textarea" rows="8" class="w-full rounded-md border-gray-300"></textarea></div><footer class="flex justify-end p-5 border-t"><button id="cancel-obs-btn" class="bg-gray-200 py-2 px-5 rounded-lg mr-3">Cancelar</button><button id="save-obs-btn" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg">Salvar</button></footer></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-md"><div class="p-6"><p id="delete-modal-text">Confirmar exclusão?</p></div><footer class="flex justify-end p-5 border-t"><button id="cancel-delete-btn" class="bg-gray-200 py-2 px-5 rounded-lg mr-3">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-5 rounded-lg">Excluir</button></footer></div></div>
    <div id="chart-modal" class="fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-4xl"><header class="flex justify-between p-5 border-b"><h2 id="chart-modal-title" class="font-bold">Gráfico</h2><button id="close-chart-modal-btn"><i class="fa-solid fa-times"></i></button></header><div class="p-6"><div class="mb-4 flex justify-center space-x-4"><label><input type="radio" name="chart-format" value="number" checked> Num</label><label><input type="radio" name="chart-format" value="currency"> R$</label><label><input type="radio" name="chart-format" value="percent"> %</label></div><canvas id="indicator-chart"></canvas></div></div></div>

    <script type="module">
        // Importa as funções do Firebase via CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // --- ⚠️ COLE SUA CONFIGURAÇÃO DO FIREBASE ABAIXO (Substitua tudo entre as chaves) ⚠️ ---
        const firebaseConfig = {
  apiKey: "AIzaSyDuQpx3JvBZ1aoF7eDueGQ9DQZCWfmsrjc",
  authDomain: "dashboard-projetos-ddafa.firebaseapp.com",
  projectId: "dashboard-projetos-ddafa",
  storageBucket: "dashboard-projetos-ddafa.firebasestorage.app",
  messagingSenderId: "179968218754",
  appId: "1:179968218754:web:ab862528bf152d29f7869b};
        // ---------------------------------------------------------------------------------------

        // Inicializa Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase conectado com sucesso!");
        } catch (error) {
            console.error("Erro ao conectar Firebase:", error);
            alert("Erro na configuração do Firebase. Verifique se copiou as chaves corretamente no código.");
        }

        // --- VARIÁVEIS GLOBAIS ---
        const projectList = ["MIX DE PRODUTOS", "PRECIFICAÇÃO", "PBM", "PEC", "SETORIZAÇÃO (ESTACIONAMENTO)", "MARCAS PROPRIAS", "GC (FARMACINHA)", "DELIVERY (E-DELIVERY)", "INSPIRE +", "DERMACLUB", "SERVIÇOS FARMACEUTICOS", "CAMPANHA IDOSO", "MEDICAMENTOS ESPECIAIS", "FIDELIZA MAIS"];
        const statusList = [
            { value: 'pendente', text: 'Pendente', class: 'status-pendente' },
            { value: 'andamento', text: 'Em Andamento', class: 'status-andamento' },
            { value: 'pendente-associa', text: 'Pendente Associado', class: 'status-pendente-associa' },
            { value: 'finalizado', text: 'Finalizado', class: 'status-finalizado' }
        ];
        const indicatorMonths = [
            { id: 'aug2025', label: 'Ago/2025' }, { id: 'sep2025', label: 'Set/2025' }, { id: 'oct2025', label: 'Out/2025' }, { id: 'nov2025', label: 'Nov/2025' }, { id: 'dec2025', label: 'Dez/2025' },
            { id: 'jan2026', label: 'Jan/2026' }, { id: 'feb2026', label: 'Fev/2026' }, { id: 'mar2026', label: 'Mar/2026' }, { id: 'apr2026', label: 'Abr/2026' }, { id: 'may2026', label: 'Mai/2026' },
            { id: 'jun2026', label: 'Jun/2026' }, { id: 'jul2026', label: 'Jul/2026' }, { id: 'aug2026', label: 'Ago/2026' }, { id: 'sep2026', label: 'Set/2026' }, { id: 'oct2026', label: 'Out/2026' },
            { id: 'nov2026', label: 'Nov/2026' }, { id: 'dec2026', label: 'Dez/2026' }
        ];
        const chartLabels = indicatorMonths.map(m => m.label);

        let allFlattenedData = [];
        let currentChartInstance = null;
        let consolidatedChartInstance = null;
        let currentChartRowData = null;

        // Elementos DOM
        const loadingOverlay = document.getElementById('loading-overlay');
        const projectTableBody = document.getElementById('project-table-body');
        const storeModal = document.getElementById('store-modal');
        const storeForm = document.getElementById('store-form');
        const toast = document.getElementById('toast');
        // (Outros elementos pegos conforme uso para economizar linhas)

        // --- FUNÇÕES DE DADOS (AGORA COM FIREBASE) ---

        // Carrega dados em Tempo Real
        function iniciarOuvinteFirebase() {
            if (!db) return;
            const q = collection(db, "lojas");
            
            // O snapshot dispara sempre que algo muda no banco
            onSnapshot(q, (querySnapshot) => {
                const stores = [];
                querySnapshot.forEach((doc) => {
                    stores.push({ id: doc.id, ...doc.data() });
                });
                processarDados(stores);
                loadingOverlay.classList.add('hidden-overlay');
            }, (error) => {
                console.error("Erro ao ler dados:", error);
                showToast("Erro de permissão ou conexão com Firebase.", true);
                loadingOverlay.classList.add('hidden-overlay');
            });
        }

        function processarDados(stores) {
            allFlattenedData = [];
            const filterOptions = { analistas: new Set(), ges: new Set(), associados: new Set(), anjos: new Set(), ufs: new Set(), bandeiras: new Set() };

            stores.forEach((store) => {
                if (store.analista) filterOptions.analistas.add(store.analista);
                if (store.ge) filterOptions.ges.add(store.ge);
                if (store.associado) filterOptions.associados.add(store.associado);
                if (store.anjo) filterOptions.anjos.add(store.anjo);
                if (store.uf) filterOptions.ufs.add(store.uf);
                if (store.bandeira) filterOptions.bandeiras.add(store.bandeira);

                if (store.projects) {
                    Object.keys(store.projects).forEach(projectName => {
                        const project = store.projects[projectName];
                        const row = {
                            ...store, // ID, nomeLoja, etc
                            projectName: projectName,
                            status: project.status,
                            goal: project.goal || '',
                            observation: project.observation || '',
                            ...project.indicators
                        };
                        delete row.projects; // Remove o objeto aninhado da linha plana
                        allFlattenedData.push(row);
                    });
                }
            });

            allFlattenedData.sort((a, b) => a.nomeLoja.localeCompare(b.nomeLoja));
            recalculateKPIs();
            populateFilterSelects(filterOptions);
            applyAllFilters(); // Reaplica filtros na tela
        }

        async function salvarLojaFirebase(storeId, data) {
            // data deve ser o objeto completo da loja
            try {
                await setDoc(doc(db, "lojas", storeId), data, { merge: true });
                showToast("Dados salvos no Firebase!");
            } catch (error) {
                console.error("Erro ao salvar:", error);
                showToast("Erro ao salvar: " + error.message, true);
            }
        }

        async function atualizarProjetoFirebase(storeId, projectName, fieldPath, value) {
            // Atualiza um campo específico de um projeto (ex: status, meta, indicador)
            try {
                const docRef = doc(db, "lojas", storeId);
                // Monta o caminho do campo: "projects.NOME_DO_PROJETO.CAMPO"
                const updateKey = `projects.${projectName}.${fieldPath}`;
                
                await updateDoc(docRef, {
                    [updateKey]: value
                });
                // Não precisa de showToast aqui pra não poluir, o onSnapshot atualiza a tela
            } catch (error) {
                console.error("Erro update:", error);
                showToast("Erro ao atualizar campo.", true);
            }
        }
        
        async function deletarProjetoFirebase(storeId, projectName) {
            try {
                const docRef = doc(db, "lojas", storeId);
                // Para deletar um campo de mapa no Firestore, usamos deleteField() 
                // Mas como estamos importando modulos, o jeito mais facil é ler, apagar do objeto e salvar de volta
                // Ou usar update com notation de delete. No SDK v9 o deleteField é importado.
                // Vamos simplificar: ler o doc atual, remover a chave e salvar.
                // (Nota: o ideal seria deleteField, mas exigiria mais imports)
                
                // Opção Robust:
                // import { deleteField } from '...firestore.js';
                // await updateDoc(docRef, { [`projects.${projectName}`]: deleteField() });
                
                // Vamos improvisar para manter imports simples: ler, apagar, set.
                // Como temos os dados locais atualizados (stores no onSnapshot), poderiamos usar.
                // Mas vamos fazer o update com o valor especial do Firestore para deletar seria melhor.
                // Vou adicionar o import deleteField dinamicamente.
                const { deleteField } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                
                await updateDoc(docRef, {
                    [`projects.${projectName}`]: deleteField()
                });
                
                showToast("Projeto excluído!");
            } catch (error) {
                console.error("Erro delete:", error);
                showToast("Erro ao excluir.", true);
            }
        }

        // --- MANIPULAÇÃO DA TELA (ADAPTADA) ---

        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-store-btn');
            btn.textContent = 'Salvando...'; btn.disabled = true;

            const formData = new FormData(storeForm);
            const storeId = formData.get('cnpj'); // ID é o CNPJ
            const isEditMode = document.getElementById('cnpj').readOnly;

            // Dados básicos da loja
            const storeData = {
                analista: formData.get('analista'),
                anjo: formData.get('anjo'),
                uf: formData.get('uf'),
                bandeira: formData.get('bandeira'),
                ge: formData.get('ge'),
                associado: formData.get('associado'),
                nomeLoja: formData.get('nome-loja'),
            };

            if (isEditMode) {
                // Modo Edição: Apenas dados da loja
                await salvarLojaFirebase(storeId, storeData);
            } else {
                // Modo Criação de Projeto
                const projectName = formData.get('nome-projeto');
                if (!storeId || !projectName) { showToast("CNPJ e Projeto obrigatórios", true); btn.disabled=false; return; }

                // Busca dados atuais da loja para não sobrescrever outros projetos
                // O setDoc com {merge:true} faz isso, mas para criar a estrutura deep:
                const indicators = {}; indicatorMonths.forEach(m => indicators[m.id] = '');
                
                const newProject = {
                    status: 'pendente',
                    goal: formData.get('meta') || '',
                    observation: formData.get('observation') || '',
                    indicators: indicators
                };

                // Estrutura para salvar: projects.NOME = objeto
                // No Firestore setDoc com merge lida bem com objetos aninhados se usarmos dot notation no update,
                // mas aqui estamos enviando um objeto "projects" inteiro se for novo.
                // Melhor estratégia: Pegar o doc atual (se existir) ou criar.
                
                // Vamos usar setDoc com merge no nivel raiz.
                // Precisa mandar { projects: { [projectName]: newProject }, ...storeData }
                const payload = {
                    ...storeData,
                    projects: {
                        [projectName]: newProject
                    }
                };
                
                // O merge:true do Firestore vai mesclar o mapa "projects" ou substituir?
                // O setDoc com merge mescla campos de alto nível. Se "projects" já existe, ele mescla o conteúdo SE usarmos a notação de ponto
                // OU se usarmos SetOptions mergeFields.
                // A forma mais segura sem complicar é usar updateDoc se já existe, setDoc se não.
                // Mas para simplificar neste código único:
                // Vamos usar dot notation para a chave do projeto no payload é mais seguro para não apagar os outros.
                // Mas dot notation não funciona direto no objeto literal JS.
                
                // Solução Híbrida Segura:
                // 1. Salva dados da loja
                await setDoc(doc(db, "lojas", storeId), storeData, { merge: true });
                // 2. Atualiza o projeto específico
                await atualizarProjetoFirebase(storeId, projectName, "", newProject); 
                // (Nota: minha função atualizarProjetoFirebase espera um fieldPath. Se passar string vazia, não dá.
                //  Vamos fazer um update direto aqui).
                const docRef = doc(db, "lojas", storeId);
                await updateDoc(docRef, {
                    [`projects.${projectName}`]: newProject
                });
            }

            document.getElementById('store-modal').classList.add('hidden');
            storeForm.reset();
            btn.textContent = 'Salvar'; btn.disabled = false;
        };
        
        // Expor funções para o HTML (onClick)
        window.handleStatusChange = (e) => {
            const { storeId, projectName } = e.target.dataset;
            atualizarProjetoFirebase(storeId, projectName, "status", e.target.value);
            // Atualiza visualmente na hora para feedback rápido (opcional, pois o snapshot já fará)
            updateStatusColor(e.target);
        };

        window.handleIndicatorChange = (e) => {
            const { storeId, projectName, month } = e.target.dataset;
            // indicators é um sub-objeto. Caminho: projects.PROJETO.indicators.MES
            const path = `indicators.${month}`;
            atualizarProjetoFirebase(storeId, projectName, path, e.target.value);
        };
        
        window.handleMetaChange = (e) => {
            const { storeId, projectName } = e.target.dataset;
            atualizarProjetoFirebase(storeId, projectName, "goal", e.target.value);
        };

        window.handleSaveObservation = () => {
            const btn = document.getElementById('save-obs-btn');
            const { storeId, projectName } = btn.dataset;
            const val = document.getElementById('obs-modal-textarea').value;
            atualizarProjetoFirebase(storeId, projectName, "observation", val);
            document.getElementById('obs-modal').classList.add('hidden');
            showToast("Observação salva!");
        };

        window.confirmProjectDelete = () => {
             const btn = document.getElementById('confirm-delete-btn');
             const { storeId, projectName } = btn.dataset;
             deletarProjetoFirebase(storeId, projectName);
             document.getElementById('delete-confirm-modal').classList.add('hidden');
        };

        // --- FUNÇÕES DE INTERFACE AUXILIARES (Reutilizadas) ---
        function showToast(msg, err=false) { toast.textContent=msg; toast.className = `fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg transform transition-all duration-300 z-50 ${err?'bg-red-600':'bg-green-600'} translate-x-0 opacity-100`; setTimeout(()=>toast.classList.add('translate-x-full', 'opacity-0'), 3000); }
        function updateStatusColor(el) { statusList.forEach(s=>el.classList.remove(s.class)); const st = statusList.find(s=>s.value===el.value); if(st) el.classList.add(st.class); else el.classList.add('status-default'); }
        function populateFilterSelects(opt) {
            const fill = (id, set) => { const el = document.getElementById(id); const val = el.value; el.innerHTML='<option value="">Todos</option>'; [...set].sort().forEach(x=>{if(x)el.innerHTML+=`<option value="${x}">${x}</option>`}); el.value=val; };
            fill('filter-analista', opt.analistas); fill('filter-ge', opt.ges); fill('filter-associado', opt.associados);
            fill('filter-uf', opt.ufs); fill('filter-anjo', opt.anjos); fill('filter-bandeira', opt.bandeiras);
            fill('chart-filter-ge', opt.ges);
            // Projetos
            const pSel = document.getElementById('filter-projeto'); const pVal = pSel.value; pSel.innerHTML='<option value="">Todos</option>'; projectList.forEach(p=>pSel.innerHTML+=`<option value="${p}">${p}</option>`); pSel.value=pVal;
            const cSel = document.getElementById('chart-filter-project'); const cVal = cSel.value; cSel.innerHTML='<option value="" disabled selected>Selecione...</option>'; projectList.forEach(p=>cSel.innerHTML+=`<option value="${p}">${p}</option>`); cSel.value=cVal;
            const mSel = document.getElementById('nome-projeto'); mSel.innerHTML='<option value="" disabled selected>Selecione...</option>'; projectList.forEach(p=>mSel.innerHTML+=`<option value="${p}">${p}</option>`);
        }
        function recalculateKPIs() {
            const kpi = { totalLojas: new Set(), pendente:0, pendenteAssocia:0, andamento:0, finalizado:0 };
            allFlattenedData.forEach(r => {
                kpi.totalLojas.add(r.id);
                if(r.status==='pendente') kpi.pendente++;
                else if(r.status==='pendente-associa') kpi.pendenteAssocia++;
                else if(r.status==='andamento') kpi.andamento++;
                else if(r.status==='finalizado') kpi.finalizado++;
            });
            document.getElementById('kpi-total-lojas').textContent = kpi.totalLojas.size;
            document.getElementById('kpi-projetos-pendentes').textContent = kpi.pendente;
            document.getElementById('kpi-projetos-pendentes-associa').textContent = kpi.pendenteAssocia;
            document.getElementById('kpi-em-andamento').textContent = kpi.andamento;
            document.getElementById('kpi-projetos-finalizados').textContent = kpi.finalizado;
        }

        function renderTable(data) {
            projectTableBody.innerHTML = '';
            if(!data.length) { projectTableBody.innerHTML = '<tr><td colspan="30" class="text-center p-8 text-gray-500">Nenhum dado encontrado.</td></tr>'; return; }
            
            data.forEach(row => {
                const tr = document.createElement('tr'); tr.className = 'bg-white border-b hover:bg-gray-50';
                const stClass = statusList.find(s=>s.value===row.status)?.class || 'status-default';
                const stOpts = statusList.map(s=>`<option value="${s.value}" ${s.value===row.status?'selected':''}>${s.text}</option>`).join('');
                const indicators = indicatorMonths.map(m => `
                    <td class="px-4 py-2 text-center"><input type="number" class="indicator-input-table" value="${row[m.id]||''}" placeholder="-" data-store-id="${row.id}" data-project-name="${row.projectName}" data-month="${m.id}" onblur="handleIndicatorChange(event)"></td>
                `).join('');
                
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${row.nomeLoja||'-'}</td>
                    <td class="px-4 py-3 text-gray-600">${row.id}</td>
                    <td class="px-4 py-3 text-gray-600">${row.analista||'-'}</td>
                    <td class="px-4 py-3 text-gray-600">${row.ge||'-'}</td>
                    <td class="px-4 py-3 text-gray-600">${row.associado||'-'}</td>
                    <td class="px-4 py-3 text-gray-600">${row.bandeira||'-'}</td>
                    <td class="px-4 py-3 font-medium text-gray-800">${row.projectName}</td>
                    <td class="px-4 py-3 text-center"><select class="status-select ${stClass}" data-store-id="${row.id}" data-project-name="${row.projectName}" onchange="handleStatusChange(event)">${stOpts}</select></td>
                    <td class="px-4 py-2 text-center"><input type="number" class="indicator-input-table" value="${row.goal||''}" placeholder="-" data-store-id="${row.id}" data-project-name="${row.projectName}" onblur="handleMetaChange(event)"></td>
                    ${indicators}
                    <td class="px-4 py-3 text-center"><button class="view-obs-btn ${row.observation?'obs-filled':'text-gray-400'}" onclick="openObs('${row.id}','${row.projectName}','${row.observation||''}')"><i class="fa-solid fa-note-sticky fa-lg"></i></button></td>
                    <td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-x-3 min-w-[120px]">
                        <button class="text-blue-500" onclick="editStore('${row.id}')"><i class="fa-solid fa-pencil fa-lg"></i></button>
                        <button class="text-[#FF5510]" onclick="openChart('${row.id}','${row.projectName}')"><i class="fa-solid fa-chart-line fa-lg"></i></button>
                        <button class="text-red-500" onclick="askDelete('${row.id}','${row.projectName}')"><i class="fa-solid fa-trash fa-lg"></i></button>
                    </div></td>
                `;
                projectTableBody.appendChild(tr);
            });
        }
        
        // Funções Globais para o HTML chamar
        window.openObs = (id, proj, obs) => {
            document.getElementById('obs-modal-title').textContent = `Obs: ${proj}`;
            document.getElementById('obs-modal-textarea').value = obs;
            const btn = document.getElementById('save-obs-btn'); btn.dataset.storeId=id; btn.dataset.projectName=proj;
            document.getElementById('obs-modal').classList.remove('hidden');
        };
        window.editStore = (id) => {
            const row = allFlattenedData.find(r=>r.id===id);
            if(!row) return;
            document.getElementById('cnpj').value = row.id; document.getElementById('cnpj').readOnly=true;
            document.getElementById('nome-loja').value = row.nomeLoja;
            document.getElementById('analista').value = row.analista||'';
            document.getElementById('ge').value = row.ge||'';
            document.getElementById('associado').value = row.associado||'';
            document.getElementById('bandeira').value = row.bandeira||'';
            document.getElementById('uf').value = row.uf||'';
            document.getElementById('anjo').value = row.anjo||'';
            
            document.getElementById('store-modal-title').textContent="Editar Loja";
            document.getElementById('save-store-btn').textContent="Atualizar Loja";
            document.getElementById('form-project-group').style.display='none';
            document.getElementById('form-meta-group').style.display='none';
            document.getElementById('form-observation-group').style.display='none';
            document.getElementById('nome-projeto').required=false;
            document.getElementById('store-modal').classList.remove('hidden');
        };
        window.askDelete = (id, proj) => {
            document.getElementById('delete-modal-text').textContent = `Excluir projeto "${proj}"?`;
            const btn = document.getElementById('confirm-delete-btn'); btn.dataset.storeId=id; btn.dataset.projectName=proj;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        };
        window.openChart = (id, proj) => {
            const row = allFlattenedData.find(r=>r.id===id && r.projectName===proj);
            if(!row) return;
            currentChartRowData = row;
            renderChart(row);
            document.getElementById('chart-modal').classList.remove('hidden');
        };

        function applyAllFilters() {
            const s = document.getElementById('search-input').value.toLowerCase();
            const fAna = document.getElementById('filter-analista').value;
            const fGe = document.getElementById('filter-ge').value;
            const fProj = document.getElementById('filter-projeto').value;
            const fCnpj = document.getElementById('filter-cnpj').value.toLowerCase();
            const fLoja = document.getElementById('filter-loja').value.toLowerCase();
            
            const filtered = allFlattenedData.filter(r => {
                return (s==='' || r.nomeLoja.toLowerCase().includes(s) || r.id.includes(s)) &&
                       (fAna==='' || r.analista===fAna) &&
                       (fGe==='' || r.ge===fGe) &&
                       (fProj==='' || r.projectName===fProj) &&
                       (fCnpj==='' || r.id.includes(fCnpj)) &&
                       (fLoja==='' || r.nomeLoja.toLowerCase().includes(fLoja));
            });
            renderTable(filtered);
        }

        // Gráfico (Chart.js)
        function renderChart(row, format='number') {
            const ctx = document.getElementById('indicator-chart').getContext('2d');
            const data = indicatorMonths.map(m => Number(row[m.id])||0);
            if(currentChartInstance) currentChartInstance.destroy();
            currentChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: [{ label: 'Realizado', data: data, borderColor: '#FF5510', backgroundColor: 'rgba(255,85,16,0.1)', fill: true }] },
                options: { responsive:true, plugins: { annotation: { annotations: { line1: { type: 'line', yMin: Number(row.goal)||0, yMax: Number(row.goal)||0, borderColor: 'red', borderWidth: 2, borderDash: [5,5], label: { content: 'Meta', enabled: true } } } } } }
            });
        }
        
        // Gráfico Consolidado
        document.getElementById('generate-chart-btn').addEventListener('click', () => {
             const proj = document.getElementById('chart-filter-project').value;
             if(!proj) { showToast("Selecione um projeto", true); return; }
             const filtered = allFlattenedData.filter(r => r.projectName === proj);
             const datasets = filtered.map(r => ({
                 label: r.nomeLoja,
                 data: indicatorMonths.map(m => Number(r[m.id])||0),
                 borderColor: '#'+Math.floor(Math.random()*16777215).toString(16),
                 fill: false
             }));
             const ctx = document.getElementById('consolidated-chart').getContext('2d');
             if(consolidatedChartInstance) consolidatedChartInstance.destroy();
             consolidatedChartInstance = new Chart(ctx, { type: 'line', data: { labels: chartLabels, datasets: datasets } });
        });

        // Event Listeners UI
        document.getElementById('store-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('open-modal-btn').addEventListener('click', () => {
            storeForm.reset(); document.getElementById('cnpj').readOnly=false;
            document.getElementById('store-modal-title').textContent="Nova Loja";
            document.getElementById('save-store-btn').textContent="Salvar";
            document.getElementById('form-project-group').style.display='block';
            document.getElementById('form-meta-group').style.display='block';
            document.getElementById('form-observation-group').style.display='block';
            document.getElementById('nome-projeto').required=true;
            document.getElementById('store-modal').classList.remove('hidden');
        });
        document.getElementById('close-modal-btn').addEventListener('click', ()=>document.getElementById('store-modal').classList.add('hidden'));
        document.getElementById('cancel-modal-btn').addEventListener('click', ()=>document.getElementById('store-modal').classList.add('hidden'));
        document.getElementById('close-chart-modal-btn').addEventListener('click', ()=>document.getElementById('chart-modal').classList.add('hidden'));
        document.getElementById('close-obs-modal-btn').addEventListener('click', ()=>document.getElementById('obs-modal').classList.add('hidden'));
        document.getElementById('cancel-obs-btn').addEventListener('click', ()=>document.getElementById('obs-modal').classList.add('hidden'));
        document.getElementById('save-obs-btn').addEventListener('click', handleSaveObservation);
        document.getElementById('cancel-delete-btn').addEventListener('click', ()=>document.getElementById('delete-confirm-modal').classList.add('hidden'));
        document.getElementById('confirm-delete-btn').addEventListener('click', confirmProjectDelete);
        
        document.getElementById('toggle-filter-btn').addEventListener('click', ()=>document.getElementById('filter-sidebar').classList.toggle('-translate-x-full'));
        document.getElementById('apply-filters-btn').addEventListener('click', applyAllFilters);
        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.querySelectorAll('#filter-sidebar select, #filter-sidebar input').forEach(e=>e.value='');
            applyAllFilters();
        });
        document.getElementById('search-input').addEventListener('input', applyAllFilters);

        // Inicialização
        if(firebaseConfig.apiKey !== "SUA_API_KEY_AQUI") {
            iniciarOuvinteFirebase();
        } else {
            loadingOverlay.innerHTML = "<div>⚠️ <strong>Configuração Pendente</strong><br>Abra o código e cole sua API Key do Firebase.</div>";
        }
    </script>
</body>
</html>